-----------------------------------------------------------------------------
--
-- Module      :  Barcode.Linear.Code39
-- Copyright   :
-- License     :  AllRightsReserved
--
-- Maintainer  :
-- Stability   :
-- Portability :
--
-- |
--
-----------------------------------------------------------------------------

module Barcode.Linear.Code39 (
    Code39(..)
) where

import Barcode.Linear.Common
import Barcode.Linear.Util
import qualified Data.Map as M

data Code39 = Code39 Bool | Code39Extended Bool

instance Encoder Code39 where
    encode (Code39Extended check) s = do
        pureCode39 <- mapM (\x->M.lookup x extMap) s
        encode (Code39 check) (concat pureCode39)
    encode (Code39 check) s = do
        list <- convData encTable s
        let
            digits = if check then list ++ [sum list `mod` 43] else list
        codes <- convIndex encTable digits
        let
            ccodes = concatMap (++[White 1]) codes
        return $ startStop ++ [White 1] ++ ccodes ++ [White 1] ++ startStop

encTable :: [(Char,[Int])]
encTable = [    ('0',[1,1,1,2,2,1,2,1,1]), ('1',[2,1,1,2,1,1,1,1,2]),
                ('2',[1,1,2,2,1,1,1,1,2]), ('3',[2,1,2,2,1,1,1,1,1]),
                ('4',[1,1,1,2,2,1,1,1,2]), ('5',[2,1,1,2,2,1,1,1,1]),
                ('6',[1,1,2,2,2,1,1,1,1]), ('7',[1,1,1,2,1,1,2,1,2]),
                ('8',[2,1,1,2,1,1,2,1,1]), ('9',[1,1,2,2,1,1,2,1,1]),
                ('A',[2,1,1,1,1,2,1,1,2]), ('B',[1,1,2,1,1,2,1,1,2]),
                ('C',[2,1,2,1,1,2,1,1,1]), ('D',[1,1,1,1,2,2,1,1,2]),
                ('E',[2,1,1,1,2,2,1,1,1]), ('F',[1,1,2,1,2,2,1,1,1]),
                ('G',[1,1,1,1,1,2,2,1,2]), ('H',[2,1,1,1,1,2,2,1,1]),
                ('I',[1,1,2,1,1,2,2,1,1]), ('J',[1,1,1,1,2,2,2,1,1]),
                ('K',[2,1,1,1,1,1,1,2,2]), ('L',[1,1,2,1,1,1,1,2,2]),
                ('M',[2,1,2,1,1,1,1,2,1]), ('N',[1,1,1,1,2,1,1,2,2]),
                ('O',[2,1,1,1,2,1,1,2,1]), ('P',[1,1,2,1,2,1,1,2,1]),
                ('Q',[1,1,1,1,1,1,2,2,2]), ('R',[2,1,1,1,1,1,2,2,1]),
                ('S',[1,1,2,1,1,1,2,2,1]), ('T',[1,1,1,1,2,1,2,2,1]),
                ('U',[2,2,1,1,1,1,1,1,2]), ('V',[1,2,2,1,1,1,1,1,2]),
                ('W',[2,2,2,1,1,1,1,1,1]), ('X',[1,2,1,1,2,1,1,1,2]),
                ('Y',[2,2,1,1,2,1,1,1,1]), ('Z',[1,2,2,1,2,1,1,1,1]),
                ('-',[1,2,1,1,1,1,2,1,2]), ('.',[2,2,1,1,1,1,2,1,1]),
                (' ',[1,2,2,1,1,1,2,1,1]), ('$',[1,2,1,2,1,2,1,1,1]),
                ('/',[1,2,1,2,1,1,1,2,1]), ('+',[1,2,1,1,1,2,1,2,1]),
                ('%',[1,1,1,2,1,2,1,2,1])]

-- | Encoding of the start/stop symbol
startStop :: [Bar]
startStop = convertEnc [1,2,1,1,2,1,2,1,1]

extTable :: [(Char, String)]
extTable = [    ('\NUL', "%U"), (' '," "), ('@', "%V"), ('`', "%W"),
                ('\SOH', "$A"), ('!', "/A"), ('A', "A"), ('a', "+A"),
                ('\STX', "$B"), ('"', "/B"), ('B', "B"), ('b', "+B"),
                ('\ETX', "$C"), ('#', "/C"), ('C', "C"), ('c', "+C"),
                ('\EOT', "$D"), ('$', "/D"), ('D', "D"), ('d', "+D"),
                ('\ENQ', "$E"), ('%', "/E"), ('E', "E"), ('e', "+E"),
                ('\ACK', "$F"), ('&', "/F"), ('F', "F"), ('f', "+F"),
                ('\BEL', "$G"), ('\'', "/G"), ('G', "G"), ('g', "+G"),
                ('\BS',  "$H"), ('(', "/H"), ('H', "H"),  ('h', "+H"),
                ('\HT', "$I"), (')', "/I"), ('I', "I"), ('i', "+I"),
                ('\LF', "$J"), ('*',"/J"), ('J', "J"), ('j', "+J"),
                ('\VT', "$K"), ('+',"/K"), ('K', "K"), ('k', "+K"),
                ('\FF', "$L"), (',',"/L"), ('L', "L"), ('l', "+L"),
                ('\CR', "$M"), ('-',"-"), ('M', "M"), ('m', "+M"),
                ('\SO', "$N"), ('.',"."), ('N', "N"), ('n', "+N"),
                ('\SI', "$O"), ('/',"/O"), ('O', "O"), ('o', "+O"),
                ('\DLE', "$P"), ('0',"0"), ('P', "P"), ('p', "+P"),
                ('\DC1', "$Q"), ('1',"1"), ('Q', "Q"), ('q', "+Q"),
                ('\DC2', "$R"), ('2',"2"), ('R', "R"), ('r', "+R"),
                ('\DC3', "$S"), ('3',"3"), ('S', "S"), ('s', "+S"),
                ('\DC4', "$T"), ('4',"4"), ('T', "T"), ('t', "+T"),
                ('\NAK', "$U"), ('5',"5"), ('U', "U"), ('u', "+U"),
                ('\SYN', "$V"), ('6',"6"), ('V', "V"), ('v', "+V"),
                ('\ETB', "$W"), ('7',"7"), ('W', "W"), ('w', "+W"),
                ('\CAN', "$X"), ('8',"8"), ('X', "X"), ('x', "+X"),
                ('\EM', "$Y"), ('9',"9"), ('Y', "Y"), ('y', "+Y"),
                ('\SUB', "$Z"), (':',"/Z"), ('Z', "Z"), ('z', "+Z"),
                ('\ESC', "%A"), (';',"%F"), ('[', "%K"), ('{', "%P"),
                ('\FS', "%B"), ('<',"%G"), ('\\', "%L"), ('|', "%Q"),
                ('\GS', "%C"), ('=',"%H"), (']', "%M"), ('}', "%R"),
                ('\RS', "%D"), ('>',"%I"), ('^', "%N"), ('~', "%S"),
                ('\US', "%E"), ('?',"%J"), ('_', "%O"), ('\DEL', "%T")]

extMap :: M.Map Char String
extMap = M.fromList $ extTable

